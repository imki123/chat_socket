<!DOCTYPE html>
<html>
	<head>
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		<meta name="theme-color" content="#000000" />
		<title>OnAndOff-imki123</title>
	</head>
	<body>
		<div class="bodyWrapper">
			<div class="board">
				<div class="boardContent">
					<div class="usage">
						<div class="boardTitle">ê²Œì„ ë°©ë²•</div>
						<div class="boardList">
							<div>- ë¶ˆì´ ì¼œì ¸ ìˆì„ ë•ŒëŠ” ë²„íŠ¼ì„ ëª¨ë‘ OFFë¡œ ë°”ê¿”ì•¼í•©ë‹ˆë‹¤.</div>
							<div>- ë¶ˆì´ êº¼ì ¸ ìˆì„ ë•ŒëŠ” ë²„íŠ¼ì„ ëª¨ë‘ ONìœ¼ë¡œ ë°”ê¿”ì•¼í•©ë‹ˆë‹¤.</div>
						</div>
					</div>
					<div class="recent">
						<div class="boardTitle">ìµœê·¼ ì„±ê³µ</div>
						<div class="boardList">
						</div>
					</div>
					<div class="week">
						<div class="boardTitle">ì¼ì£¼ì¼ ë­í‚¹</div>
						<div class="boardList">
						</div>
					</div>
					<div class="month">
						<div class="boardTitle">í•œë‹¬ ë­í‚¹</div>
						<div class="boardList">
						</div>
					</div>
				</div>
			</div>
			<div class="game">
				<button onclick="clickButton(this)" id="button_1">ON</button>
				<button onclick="clickButton(this)" id="button_2">ON</button>
				<button onclick="clickButton(this)" id="button_3">ON</button>
				<button onclick="clickButton(this)" id="button_4">ON</button>
				<button onclick="clickButton(this)" id="button_5">ON</button>
				<button onclick="clickButton(this)" id="button_6">ON</button>
				<button onclick="clickButton(this)" id="button_7">ON</button>
				<button onclick="clickButton(this)" id="button_8">ON</button>
				<button onclick="clickButton(this)" id="button_9">ON</button>
				<button onclick="clickButton(this)" id="button_10">ON</button>
			</div>
			<div class="chat">
				<div class="msgs"></div>
				<div class="inputs">
					<div class="client">guest</div>
					<input id="chat" autocomplete="off" onkeypress="sendOnEnter(event)" placeholder="ëŒ€í™”í•´ë³´ì„¸ìš” :D" />
					<div class="clientsLength hover no-drag" onclick="toggleClients()">0ëª…</div>
					<button onclick="send()">Send</button>
				</div>
				<div class="allClientsWrapper" onclick="toggleClients()">
					<div class="allClients">
						<div>ì ‘ì†ì ëª©ë¡</div>
						<div class="allClientsList"></div>
					</div>
				</div>
			</div>
		</div>

		<style>
			* {
				margin: 0;
				padding: 0;
				box-sizing: border-box;
			}

			button,
			img,
			.no-drag {
				-ms-user-select: none;
				-moz-user-select: -moz-none;
				-webkit-user-select: none;
				-khtml-user-select: none;
				user-select: none;
			}
			button {
				cursor: pointer;
			}
			.hover:hover {
				cursor: pointer;
				opacity: 0.8;
			}
			body {
				font: 0.9rem Helvetica, Arial;
			}

			.bodyWrapper {
				position: relative;
				width: 100%;
				height: 100vh;
				margin: auto;
				display: flex;
				justify-content: flex-start;
				align-items: flex-start;
				flex-wrap: wrap;
				flex-direction: column;
				border: 1px solid black;
				max-width: 1000px;
				min-width: 300px;
			}
			.board{
				width: 100%;
			}
			.boardContent {
				display: flex;
				justify-content: space-around;
				align-items: flex-start;
				text-align: left;

				width: 100%;
				height: 130px;
			}
			.boardContent>*{
				width: 25%;
				height: 100%;
				overflow: auto;
				border-right: 1px solid black;
				border-bottom: 1px solid black;
			}
			.boardContent div:nth-child(4){
				border-right: 0;
			}
			.boardTitle{
				font-weight: bold;
				font-size: 1rem;
				padding: 2px;
				background: rgb(168, 255, 168);
				white-space: nowrap;
    		overflow: hidden;
			}
			.boardList div{
				width: 100%;
				padding: 0px 5px;
				font-size: 0.8rem;

				display: flex;
				justify-content: space-between;
			}
			.boardList div span:nth-child(1){
				white-space: nowrap;
    		overflow: hidden;
			}
			.boardList div span:nth-child(2){
				padding: 2px;
			}

			.game {
				display: flex;
				flex-wrap: wrap;
				justify-content: center;
				align-items: center;

				width: 100%;
				height: calc(40vh - 1px);
				background: yellow;
				border-bottom: 1px solid black;
			}
			.game button {
				width: 80px;
				padding: 20px 10px;
				margin: 1px;
				font-size: 1.5rem;
				font-weight: bold;
				background: white;
				color: black;
				border-radius: 20px;
				outline: none;
			}
			.game button.off {
				background: black;
				color: white;
			}

			.chat {
				position: absolute;
				bottom: 0;
				width: 100%;
			}
			.msgs > * {
				padding: 5px 10px;
				width: 100%;
			}
			.msgs {
				width: 100%;
				max-height: calc(60vh - 171px);
				list-style-type: none;
				overflow-y: auto;
			}
			.msgs .date {
				background: #eee;
			}
			.msgs .connect {
				background: #ffff78;
			}
			.msgs .disconnect {
				background: #ffffd0;
			}
			.msgs .time {
				color: gray;
				font-size: 0.7rem;
			}

			.inputs {
				background: #000;
				padding: 3px;
				height: 40px;
				width: 100%;

				display: flex;
				justify-content: space-between;
				align-items: flex-end;
			}
			.inputs > * {
				height: 33px;
			}
			.client {
				background: white;
				padding: 8px;
				margin-right: 3px;
			}
			input {
				border: 0;
				padding: 9px;
				width: 100%;
				margin-right: 5px;
			}
			.clientsLength {
				background: white;
				border: none;
				padding: 7px;
				margin-right: 5px;
				min-width: 40px;
				text-align: right;
			}
			.chat button {
				background: rgb(130, 224, 255);
				border: none;
				padding: 9px;
			}
			.allClientsWrapper {
				position: absolute;
				bottom: 40px;
				right: 0px;
				z-index: 10;
				display: none;

				width: 100%;
				height: calc(100vh - 40px);
				background: rgb(214, 214, 214, 0.5);
			}
			.allClientsWrapper.view {
				display: block;
			}
			.allClients {
				position: absolute;
				bottom: 0px;
				right: 0px;

				padding: 10px;
				width: 200px;
				height: calc(50vh - 40px);
				border: 1px solid black;
				background: white;
				overflow: auto;
			}

			.allClientsList {
				margin-top: 10px;
			}
		</style>

		<!-- socket.io CDN -->
		<script src="https://cdn.jsdelivr.net/npm/socket.io-client@2/dist/socket.io.js"></script>
		<!-- <script src="/socket.io/socket.io.js"></script> -->
		<script>
			//connection event
			const socket = io() //default: window.location
			let allClients = []

			//ë²„íŠ¼í´ë¦­í•˜ë©´ ON/OFF ë°”ê¾¸ê³  ì†Œì¼“ì— ë²„íŠ¼ ì•„ì´ë”” ì „ì†¡
			function clickButton(button) {
				socket.emit('clickButton', button.id.replace('button_', ''))
				if (button.innerHTML === 'ON') {
					button.innerHTML = 'OFF'
					button.classList.add('off')
				} else {
					button.innerHTML = 'ON'
					button.classList.remove('off')
				}
			}

			function send() {
				let msg = document.querySelector('#chat')
				if (msg.value.trim() === '') return
				socket.emit('chat message', msg.value.trim())
				msg.value = ''
			}
			function sendOnEnter(event) {
				if (event.key === 'Enter') send()
			}

			//ì ‘ì†ììˆ˜ í´ë¦­í•˜ë©´ í´ë¼ì´ì–¸íŠ¸ ëª©ë¡ ë³´ì—¬ì£¼ê¸°
			function toggleClients() {
				const $allClientsWrapper = document.querySelector('.allClientsWrapper')
				if ($allClientsWrapper.classList.contains('view')) $allClientsWrapper.classList.remove('view')
				else $allClientsWrapper.classList.add('view')
			}

			window.onload = function () {
				const $game = document.querySelector('.game')
				const $msgs = document.querySelector('.msgs')
				const $clientLength = document.querySelector('.clientsLength')
				const $allClientsList = document.querySelector('.allClientsList')

				//ë²„íŠ¼ ë°°ì—´ ë°›ê¸°
				socket.on('buttons', ({buttons, recents, weeks, months, winner}) => {
					//ë°°ê²½ìƒ‰ ë°”ê¾¸ê¸°
					$game.style.background = buttons[0] 
					//ë²„íŠ¼ ë°”ê¾¸ê¸°
					for (let i = 1; i < buttons.length; i++) {
						button = document.querySelector(`#button_${i}`)
						if (buttons[i]) {
							button.innerHTML = 'ON'
							button.classList.remove('off')
						} else {
							button.innerHTML = 'OFF'
							button.classList.add('off')
						}
					}
					//console.log(buttons, recents, weeks, months)
					//recents ë Œë”ë§
					let html = ''
					recents.forEach((i,idx)=>html += `<div><span>${idx+1}. ${i.client}</span></div>`)
					document.querySelector('.recent .boardList').innerHTML = html
					//weeks ë Œë”ë§
					html = ''
					weeks.forEach((i,idx)=>html += `<div><span>${idx+1}. ${i.client}</span><span>${i.count}</span></div>`)
					document.querySelector('.week .boardList').innerHTML = html
					//months ë Œë”ë§
					html = ''
					months.forEach((i,idx)=>html += `<div><span>${idx+1}. ${i.client}</span><span>${i.count}</span></div>`)
					document.querySelector('.month .boardList').innerHTML = html
					if(winner === true){
						alert('ğŸ‰ì„±ê³µ! ì¶•í•˜í•´ìš”!!ğŸ‰')
					}else if(winner === false){
						alert('ğŸ˜…ìµœê·¼ì— ì„±ê³µí•˜ì…”ì„œ ì ìˆ˜ê°€ ì˜¬ë¼ê°€ì§€ ì•Šì•˜ì–´ìš”. ë‹¤ë¥¸ ë¶„ì´ ì„±ê³µí•œ í›„ì— ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”!')
					}
				})

				//ì ‘ì†ëœ ì‚¬ëŒ ìˆ˜ ë³´ì—¬ì£¼ê¸°
				socket.on('allClients', function ({ address, clients }) {
					//console.log(clients)
					if (clients) allClients = clients
					$clientLength.innerHTML = clients.length + 'ëª…'
					//ë‚˜ê°„ ì‚¬ëŒ ë³´ì—¬ì£¼ê¸°
					if (address) {
						const div = document.createElement('div')
						div.classList.add('disconnect')
						div.innerHTML = `${address}ë‹˜ì´ ë‚˜ê°€ì…¨ìŠµë‹ˆë‹¤`
						$msgs.append(div)
						//ë§¨ ì•„ë˜ë¡œ ìŠ¤í¬ë¡¤í•˜ê¸°
						$msgs.scrollTop = $msgs.scrollHeight + $msgs.offsetHeight
					}

					$allClientsList.innerHTML = ''
					for (let i of allClients) {
						const div = document.createElement('div')
						div.classList.add('client')
						div.innerHTML = `${i}`
						$allClientsList.append(div)
					}
				})

				//ì €ì¥ëœ ë©”ì‹œì§€ ê°€ì ¸ì˜¤ê¸°
				socket.on('get msgs', function (msgs) {
					let time = ''
					$msgs.innerHTML = ''
					for (let i of msgs) {
						if (time.substring(0, 10) !== i.time.substring(0, 10)) {
							time = i.time
							const div = document.createElement('div')
							div.classList.add('date')
							div.innerHTML = `${i.time.substring(0, 10)}`
							$msgs.append(div)
						}
						const div = document.createElement('div')
						div.classList.add('msg')
						div.innerHTML = `${i.address} : ${i.msg} <span class="time">${i.time.substring(11)}</span>`
						$msgs.append(div)
					}
					//ë§¨ ì•„ë˜ë¡œ ìŠ¤í¬ë¡¤í•˜ê¸°
					$msgs.scrollTop = $msgs.scrollHeight + $msgs.offsetHeight
				})

				//ì ‘ì†í•˜ë©´ ì ‘ì†í•œ ì‚¬ëŒ ì•„ì´ë”” ë³´ì—¬ì£¼ê¸°
				socket.on('new connect', ({ client, isMe }) => {
					const div = document.createElement('div')
					const $client = document.querySelector('.client')
					div.classList.add('connect')
					if (isMe) {
						div.innerHTML = `${client}ë‹˜ í™˜ì˜í•©ë‹ˆë‹¤ :D`
						$client.innerHTML = client
					} else div.innerHTML = `${client}ë‹˜ì´ ì ‘ì†í–ˆìŠµë‹ˆë‹¤.`
					$msgs.append(div)
					//ë§¨ ì•„ë˜ë¡œ ìŠ¤í¬ë¡¤í•˜ê¸°
					$msgs.scrollTop = $msgs.scrollHeight + $msgs.offsetHeight
				})

				//ë‚ ì§œê°€ ë³€ê²½ë˜ë©´ ë‚ ì§œ í‘œì‹œ
				let date = new Date()
				let today = date.getFullYear()
				today += date.getMonth() < 10 ? '/0' + date.getMonth() : '/' + date.getMonth()
				today += date.getDate() < 10 ? '/0' + date.getDate() : '/' + date.getDate()
				//ë©”ì‹œì§€ ë°›ìœ¼ë©´ í™”ë©´ì— ê·¸ë¦¬ê¸°
				socket.on('chat message', function ({ address, msg, time }) {
					if (today.substring(0, 10) !== time.substring(0, 10)) {
						today = time
						const div = document.createElement('div')
						div.classList.add('date')
						div.innerHTML = `${time.substring(0, 10)}`
						$msgs.append(div)
					}
					const div = document.createElement('div')
					div.classList.add('msg')
					div.innerHTML = `${address} : ${msg} <span class="time">${time.substring(11)}</span>`
					$msgs.append(div)
					//ë§¨ ì•„ë˜ë¡œ ìŠ¤í¬ë¡¤í•˜ê¸°
					$msgs.scrollTop = $msgs.scrollHeight + $msgs.offsetHeight
				})

				//clearMsgs 'ëŒ€í™”ì‚­ì œ' ì…ë ¥í•˜ë©´ ëª¨ë“  ë©”ì‹œì§€ ì‚­ì œ
				socket.on('clearMsgs', () => {
					$msgs.innerHTML = ''
					//ë§¨ ì•„ë˜ë¡œ ìŠ¤í¬ë¡¤í•˜ê¸°
					$msgs.scrollTop = $msgs.scrollHeight + $msgs.offsetHeight
				})
			}
			
		</script>
	</body>
</html>

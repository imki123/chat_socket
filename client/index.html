<!DOCTYPE html>
<html>
	<head>
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		<meta name="theme-color" content="#000000" />
		<title>Chat-imki123</title>
		<style>
			* {
				margin: 0;
				padding: 0;
				box-sizing: border-box;
			}

			button:hover, .hover:hover{
				cursor: pointer;
				opacity: 0.7;
			}
			body {
				font: 0.9rem Helvetica, Arial;
			}
			.msgs {
				position: fixed;
				bottom: 41px;
				z-index: 1;
				width: 100%;
				min-width: 300px;
				max-height: calc(100vh - 41px);

				list-style-type: none;
				margin: 0;
				padding: 0;
				overflow-y: auto;
			}
			.msgs > * {
				padding: 5px 10px;
				width: 100%;
			}
			.msgs .date {
				background: #eee;
			}
			.msgs .connect {
				background: #ffff78;
			}
			.msgs .disconnect {
				background: #ffffd0;
			}
			.msgs .time {
				color: gray;
				font-size: 0.7rem;
			}
			.chat {
				background: #000;
				padding: 3px;
				position: fixed;
				bottom: 0;
				height: 41px;
				width: 100%;
				min-width: 300px;

				display: flex;
				justify-content: space-between;
				align-items: center;
			}
			input {
				border: 0;
				padding: 10px;
				width: 100%;
				margin-right: 5px;
			}
			.clientsLength {
				background: white;
				border: none;
				padding: 9px;
				margin-right: 5px;
				min-width: 50px;
				text-align: right;
			}
			button {
				background: rgb(130, 224, 255);
				border: none;
				padding: 10px;
			}
			.allClientsWrapper {
				position: fixed;
				bottom: 41px;
				right: 0px;
				z-index: 10;
				display: none;

				width: 100%;
				height: calc(100% - 41px);
				background: rgb(214, 214, 214, 0.5);
			}
			.allClientsWrapper.view {
				display: block;
			}
			.allClients{
				position: absolute;
				bottom: 0px;
				right: 0px;

				padding: 10px;
				width: 200px;
				height: calc(50vh - 41px);
				border: 1px solid black;
				background: white;
				overflow: auto;
			}

			.allClientsList{
				margin-top: 10px;
			}
		</style>
	</head>
	<body>
		<div class="msgs"></div>
		<div class="chat">
			<input id="chat" autocomplete="off" onkeypress="sendOnEnter(event)" />
			<div class="clientsLength hover" onclick="toggleClients()">0명</div>
			<button onclick="send()">Send</button>
		</div>
		<div class="allClientsWrapper" onclick="toggleClients()">
			<div class="allClients">
				<div>접속자 목록</div>
				<div class="allClientsList"></div>
			</div>
		</div>

		<!-- socket.io CDN -->
		<script src="https://cdn.jsdelivr.net/npm/socket.io-client@2/dist/socket.io.js"></script>
		<!-- <script src="/socket.io/socket.io.js"></script> -->
		<script>
			//connection event
			const socket = io() //default: window.location
			let allClients = []

			function send() {
				let msg = document.querySelector('#chat')
				if (msg.value.trim() === '') return
				socket.emit('chat message', msg.value.trim())
				msg.value = ''
			}
			function sendOnEnter(event) {
				if (event.key === 'Enter') send()
			}

			//접속자수 클릭하면 클라이언트 목록 보여주기
			function toggleClients() {
				const $allClientsWrapper = document.querySelector('.allClientsWrapper')
				if ($allClientsWrapper.classList.contains('view')) $allClientsWrapper.classList.remove('view')
				else $allClientsWrapper.classList.add('view')
			}

			window.onload = function () {
				const $ul = document.querySelector('.msgs')
				const $clientLength = document.querySelector('.clientsLength')
				const $allClientsList = document.querySelector('.allClientsList')

				//접속된 사람 수 보여주기
				socket.on('allClients', function ({ address, clients }) {
					//console.log(clients)
					if (clients) allClients = clients
					$clientLength.innerHTML = clients.length + '명'
					//나간 사람 보여주기
					if (address) {
						const div = document.createElement('div')
						div.classList.add('disconnect')
						div.innerHTML = `${address}님이 나가셨습니다`
						document.querySelector('.msgs').append(div)
						//맨 아래로 스크롤하기
						$ul.scrollTop = $ul.scrollHeight + $ul.offsetHeight
					}

					$allClientsList.innerHTML = ''
					for (let i of allClients) {
						const div = document.createElement('div')
						div.classList.add('client')
						div.innerHTML = `${i}`
						$allClientsList.append(div)
					}
				})

				//저장된 메시지 가져오기
				socket.on('get msgs', function (msgs) {
					let time = ''
					for (let i of msgs) {
						if (time.substring(0, 10) !== i.time.substring(0, 10)) {
							time = i.time
							const div = document.createElement('div')
							div.classList.add('date')
							div.innerHTML = `${i.time.substring(0, 10)}`
							document.querySelector('.msgs').append(div)
						}
						const div = document.createElement('div')
						div.classList.add('msg')
						div.innerHTML = `${i.address} : ${i.msg} <span class="time">${i.time.substring(11)}</span>`
						document.querySelector('.msgs').innerHTML = ''
						document.querySelector('.msgs').append(div)
					}
					//맨 아래로 스크롤하기
					$ul.scrollTop = $ul.scrollHeight + $ul.offsetHeight
				})

				//접속하면 접속한 사람 아이디 보여주기
				socket.on('new connect', function (text) {
					const div = document.createElement('div')
					div.classList.add('connect')
					div.innerHTML = `${text}`
					document.querySelector('.msgs').append(div)
					//맨 아래로 스크롤하기
					$ul.scrollTop = $ul.scrollHeight + $ul.offsetHeight
				})

				//날짜가 변경되면 날짜 표시
				let date = new Date()
				let today = date.getFullYear()
				today += date.getMonth() < 10 ? '/0' + date.getMonth() : '/' + date.getMonth()
				today += date.getDate() < 10 ? '/0' + date.getDate() : '/' + date.getDate()
				//메시지 받으면 화면에 그리기
				socket.on('chat message', function ({ address, msg, time }) {
					if (today.substring(0, 10) !== time.substring(0, 10)) {
						today = time
						const div = document.createElement('div')
						div.classList.add('date')
						div.innerHTML = `${time.substring(0, 10)}`
						document.querySelector('.msgs').append(div)
					}
					const div = document.createElement('div')
					div.classList.add('msg')
					div.innerHTML = `${address} : ${msg} <span class="time">${time.substring(11)}</span>`
					document.querySelector('.msgs').append(div)
					//맨 아래로 스크롤하기
					$ul.scrollTop = $ul.scrollHeight + $ul.offsetHeight
				})
			}
		</script>
	</body>
</html>

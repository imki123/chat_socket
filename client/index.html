<!DOCTYPE html>
<html>
	<head>
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		<meta name="theme-color" content="#000000" />
		<title>OnAndOff-imki123</title>
	</head>
	<body>
		<div class="bodyWrapper">
			<div class="game">
				<button onclick="clickButton(this)" id="button_0">ON</button>
				<button onclick="clickButton(this)" id="button_1">ON</button>
				<button onclick="clickButton(this)" id="button_2">ON</button>
				<button onclick="clickButton(this)" id="button_3">ON</button>
				<button onclick="clickButton(this)" id="button_4">ON</button>
				<button onclick="clickButton(this)" id="button_5">ON</button>
				<button onclick="clickButton(this)" id="button_6">ON</button>
				<button onclick="clickButton(this)" id="button_7">ON</button>
				<button onclick="clickButton(this)" id="button_8">ON</button>
				<button onclick="clickButton(this)" id="button_9">ON</button>
			</div>
			<div class="chat">
				<div class="msgs"></div>
				<div class="inputs">
					<input id="chat" autocomplete="off" onkeypress="sendOnEnter(event)" />
					<div class="clientsLength hover no-drag" onclick="toggleClients()">0명</div>
					<button onclick="send()">Send</button>
				</div>
			</div>
		</div>
		<div class="allClientsWrapper" onclick="toggleClients()">
			<div class="allClients">
				<div>접속자 목록</div>
				<div class="allClientsList"></div>
			</div>
		</div>

		<style>
			* {
				margin: 0;
				padding: 0;
				box-sizing: border-box;
			}

			button,
			img,
			.no-drag {
				-ms-user-select: none;
				-moz-user-select: -moz-none;
				-webkit-user-select: none;
				-khtml-user-select: none;
				user-select: none;
			}
			button:hover,
			.hover:hover {
				cursor: pointer;
				opacity: 0.8;
			}
			body {
				font: 0.9rem Helvetica, Arial;
			}

			.bodyWrapper {
				position: relative;
				width: 100%;
				height: 100vh;
				margin: auto;
				display: flex;
				justify-content: flex-start;
				align-items: flex-start;
				flex-wrap: wrap;
				flex-direction: column;
				border: 1px solid black;
				max-width: 1000px;
				min-width: 300px;
			}
			.game {
				display: flex;
				flex-wrap: wrap;
				justify-content: center;
				align-items: center;

				width: 100%;
				height: calc(50vh - 3px);
				background: yellow;
				border-bottom: 1px solid black;
			}
			.game button{
				width: 80px;
				padding: 20px 10px;
				margin: 1px;
				font-size: 1.5rem;
				font-weight: bold;
				background: white;
				color: black;
				border-radius: 20px;
				outline: none;
			}
			.game button.off{
				background: black;
				color: white;
			}
			.msgs {
				width: 100%;
				max-height: calc(50vh - 41px);
				list-style-type: none;
				overflow-y: auto;
			}
			.msgs > * {
				padding: 5px 10px;
				width: 100%;
			}
			.msgs .date {
				background: #eee;
			}
			.msgs .connect {
				background: #ffff78;
			}
			.msgs .disconnect {
				background: #ffffd0;
			}
			.msgs .time {
				color: gray;
				font-size: 0.7rem;
			}
			.chat {
				position: absolute;
				bottom: 0;
				width: 100%;
			}
			.inputs{
				background: #000;
				padding: 3px;
				height: 41px;
				width: 100%;

				display: flex;
				justify-content: space-between;
				align-items: flex-end;
			}
			input {
				border: 0;
				padding: 10px;
				width: 100%;
				margin-right: 5px;
			}
			.clientsLength {
				background: white;
				border: none;
				padding: 8px;
				margin-right: 5px;
				min-width: 50px;
				text-align: right;
			}
			.chat button {
				background: rgb(130, 224, 255);
				border: none;
				padding: 10px;
			}
			.allClientsWrapper {
				position: fixed;
				bottom: 41px;
				right: 0px;
				z-index: 10;
				display: none;

				width: 100%;
				height: calc(100% - 41px);
				background: rgb(214, 214, 214, 0.5);
			}
			.allClientsWrapper.view {
				display: block;
			}
			.allClients {
				position: absolute;
				bottom: 0px;
				right: 0px;

				padding: 10px;
				width: 200px;
				height: calc(50vh - 41px);
				border: 1px solid black;
				background: white;
				overflow: auto;
			}

			.allClientsList {
				margin-top: 10px;
			}
		</style>

		<!-- socket.io CDN -->
		<script src="https://cdn.jsdelivr.net/npm/socket.io-client@2/dist/socket.io.js"></script>
		<!-- <script src="/socket.io/socket.io.js"></script> -->
		<script>
			//connection event
			const socket = io() //default: window.location
			let allClients = []

			//버튼클릭하면 ON/OFF 바꾸고 소켓에 버튼 아이디 전송
			function clickButton(button){
				socket.emit('clickButton', button.id.replace('button_',''))
				if(button.innerHTML === 'ON'){
					button.innerHTML = 'OFF'
					button.classList.add('off')
				}else{
					button.innerHTML = 'ON'
					button.classList.remove('off')
				}
			}

			function send() {
				let msg = document.querySelector('#chat')
				if (msg.value.trim() === '') return
				socket.emit('chat message', msg.value.trim())
				msg.value = ''
			}
			function sendOnEnter(event) {
				if (event.key === 'Enter') send()
			}

			//접속자수 클릭하면 클라이언트 목록 보여주기
			function toggleClients() {
				const $allClientsWrapper = document.querySelector('.allClientsWrapper')
				if ($allClientsWrapper.classList.contains('view')) $allClientsWrapper.classList.remove('view')
				else $allClientsWrapper.classList.add('view')
			}

			window.onload = function () {
				const $game = document.querySelector('.game')
				const $msgs = document.querySelector('.msgs')
				const $clientLength = document.querySelector('.clientsLength')
				const $allClientsList = document.querySelector('.allClientsList')

				//버튼 배열 받기
				socket.on('buttons', (buttons)=>{
					let same = true
					let check = buttons[0]
					for(let i=0; i<buttons.length; i++){
						if(same && check !== buttons[i]) same = false
						button = document.querySelector(`#button_${i}`)
						if(buttons[i]) {
							button.innerHTML = "ON"
							button.classList.remove('off')
						}else{
							button.innerHTML = "OFF"
							button.classList.add('off')
						}
					}
					if(same) {
						if(check) $game.style.background = 'yellow'
						else $game.style.background = 'gray'
					}
				})

				//접속된 사람 수 보여주기
				socket.on('allClients', function ({ address, clients }) {
					//console.log(clients)
					if (clients) allClients = clients
					$clientLength.innerHTML = clients.length + '명'
					//나간 사람 보여주기
					if (address) {
						const div = document.createElement('div')
						div.classList.add('disconnect')
						div.innerHTML = `${address}님이 나가셨습니다`
						$msgs.append(div)
						//맨 아래로 스크롤하기
						$msgs.scrollTop = $msgs.scrollHeight + $msgs.offsetHeight
					}

					$allClientsList.innerHTML = ''
					for (let i of allClients) {
						const div = document.createElement('div')
						div.classList.add('client')
						div.innerHTML = `${i}`
						$allClientsList.append(div)
					}
				})

				//저장된 메시지 가져오기
				socket.on('get msgs', function (msgs) {
					let time = ''
					$msgs.innerHTML = ''
					for (let i of msgs) {
						if (time.substring(0, 10) !== i.time.substring(0, 10)) {
							time = i.time
							const div = document.createElement('div')
							div.classList.add('date')
							div.innerHTML = `${i.time.substring(0, 10)}`
							$msgs.append(div)
						}
						const div = document.createElement('div')
						div.classList.add('msg')
						div.innerHTML = `${i.address} : ${i.msg} <span class="time">${i.time.substring(11)}</span>`
						$msgs.append(div)
					}
					//맨 아래로 스크롤하기
					$msgs.scrollTop = $msgs.scrollHeight + $msgs.offsetHeight
				})

				//접속하면 접속한 사람 아이디 보여주기
				socket.on('new connect', function (text) {
					const div = document.createElement('div')
					div.classList.add('connect')
					div.innerHTML = `${text}`
					$msgs.append(div)
					//맨 아래로 스크롤하기
					$msgs.scrollTop = $msgs.scrollHeight + $msgs.offsetHeight
				})

				//날짜가 변경되면 날짜 표시
				let date = new Date()
				let today = date.getFullYear()
				today += date.getMonth() < 10 ? '/0' + date.getMonth() : '/' + date.getMonth()
				today += date.getDate() < 10 ? '/0' + date.getDate() : '/' + date.getDate()
				//메시지 받으면 화면에 그리기
				socket.on('chat message', function ({ address, msg, time }) {
					if (today.substring(0, 10) !== time.substring(0, 10)) {
						today = time
						const div = document.createElement('div')
						div.classList.add('date')
						div.innerHTML = `${time.substring(0, 10)}`
						$msgs.append(div)
					}
					const div = document.createElement('div')
					div.classList.add('msg')
					div.innerHTML = `${address} : ${msg} <span class="time">${time.substring(11)}</span>`
					$msgs.append(div)
					//맨 아래로 스크롤하기
					$msgs.scrollTop = $msgs.scrollHeight + $msgs.offsetHeight
				})
			}
		</script>
	</body>
</html>
